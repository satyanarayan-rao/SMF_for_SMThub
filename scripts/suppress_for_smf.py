import os
import sys
import re
#samtools view ../bismark_mapped/merged_targeted_smf_esc_wt_to_mm10.bam | head -3
#SRR24843631.7_M04764:168:000000000-JLP2B:1:1101:14881:1815/1	99	chr12	84857637	42	251M	=	84857801	415TGTGGGTAGTAAGAAGAGTGTTTTAGTTTGGGTTTTATTGCTGTGTAGAGATATTATGATTAAGGTAATTTTTATAAATATAAGTATTTAATTGGGGTTGGTTTATAGTTTTATAAGTTTAGTTTATTATTATTATGGTTGGAAGTTTGGTAGTTGTAGGAGAAGGGTGTTGGAGAAGGAGCTGAGAGTTTTATATTTTGATTTATAGATAGAAAGGAGGAGATTGTTTTTTGCAGTTAGTTAGGAGGAGG	???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????	NM:i:40	MD:Z:0A20C29C1C0C4C0C7C1C7C5C12C3C3C5C1C5C3C0C5C2C4C0C5C4C2C2C12C20C2C2C5C0C1C3C13C3C2C9C0C9	XM:Z:.....................h..................X..........h.hh....hh.......h.h.......h.....h............x...h...x.....h.h.....x...hh.....h..h....xz.....h....x..x..x............x...........X........h..h..h.....hh.x...x.............x...h..x..X......hx.........	XR:Z:CT	XG:Z:CT
#SRR24843631.7_M04764:168:000000000-JLP2B:1:1101:14881:1815/1	147	chr12	84857801	42	251M	=	84857637	-415	GGGTGTTGGAGAAGGAGCTGAGAGTTTTATATTTTGATTTATAGATAGAAAGGAGGAGATTGTTTTTTGCAGTTAGTTAGGAGGAGGTGTTTTTTTTTATTGGGTGGAGCTTGAGTATCAGGAGATCTTAAAGCTCTTTTATATAGTGAAGCATTTTCTTTAATAAGATTAAATCTTTCTTAATAAGGCTATATTTTTTAATAGCGCTATTTTTGATGGCTGAGTATTTAAAGAAATGAATTTATGGGGGA	???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????	NM:i:54	MD:Z:5C20C2C2C5C0C1C3C13C3C2C9C0C9C1C1C3C1C1C10C6C7C2C5C2C0C2C1C9C2C2C0C2C4C0C3C2C0C2C8C1C1C0C1C0C9C1C1C0C11C1C1C12C8T0	XM:Z:.....x...........X........h..h..h.....hh.x...x.............x...h..x..X......hx.........z.h.h...h.h.x.........Hx......hX......hH.h....HhH.hh..h.x.......H.h..hH.hh..h....hh...hH.hhH.h.......Hh.h.hh.hh......Z.Hh.h.hx......X....h.h.h............h.........	XR:Z:GA	XG:Z:CT
#SRR24843631.9_M04764:168:000000000-JLP2B:1:1101:13788:1829/1	99	chr18	4689599	42	251M	=	4689809	461	TGAGGAAATATTTGGTTTGTAGAGTAGAATTTTTGAAGGTGAATAGTAGTTTTGTGTAATATATGGAAGTTAGGTTATTTTATAAAGGAGAGATATTGGGAAGTGGAGAGTTTTTTAGTTGGATAGTGGGGATTTTTTGCAGATTTTGGGGAGAGGAGGGCTATTGCCTTTAGCATTTAGCATAGAGGAGGAGGCTGGTTGCATGTAAATATTAGAGGGTAGTGTGTGCTTGTGTTAGATGAGCATGTGGC	???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????	NM:i:45	MD:Z:0A7C2C4C7C7C10C2C3C0C4C2C1C1C5C0C3C5C12C1C16C2C7C8C0C0C0C0C6C0C0C17C5C0C4C0C0C4C12C2C10C1C7C10C4C15	XM:Z:........h..x....x.......x.......x..........x..x...hx....h..h.h.z.....hx...h.....h............h.x................h..x.......x........hhhhx..X...hhx..............H..x..HH.hx..H.hhx..H.x...........Xz..x..H.......h.h.......x........H.z....x.......H......H	XR:Z:CT	XG:Z:CT

############### Idea of suppressing all non CpG methylation ###########################
#
#    TGTGGGTAGTAAGAAGAGTGTTTTAGTTTGGGTTTTATTGCTGTGTAGAGATATTATGATTAAGGTAATTTTTATAAATATAAGTATTTAATTGGGGTTGGTTTATAGTTTTATAAGTTTAGTTTATTATTATTATGGTTGGAAGTTTGGTAGTTGTAGGAGAAGGGTGTTGGAGAAGGAGCTGAGAGTTTTATATTTTGATTTATAGATAGAAAGGAGGAGATTGTTTTTTGCAGTTAGTTAGGAGGAGG
#    .....................h..................X..........h.hh....hh.......h.h.......h.....h............x...h...x.....h.h.....x...hh.....h..h....xz.....h....x..x..x............x...........X........h..h..h.....hh.x...x.............x...h..x..X......hx.........
#
#    all Z, z will be removed, because it will not contribute to defining footprint. All H, h, X, x will be checked for their upstream single base - if it is G it will be kept else will be replced with `.`.
#
#########################################################################################


def suppress_non_cg_gc(bs_seq, mvec, pattern_type = None):
    idx_loc = []
    to_suppress = [] # filtered locations
    mvec_len = len(mvec)
    suppressed_mvec = []
    for idx in range(mvec_len):
        if mvec[idx] in [".", "Z", "z"]:
            suppressed_mvec.append(".")
        else:
            if pattern_type == "HCH":
                if idx == 0:
                    suppressed_mvec.append(".")
                elif bs_seq[idx - 1] == "G":
                    suppressed_mvec.append(mvec[idx])
                else:
                    suppressed_mvec.append(".")
            elif pattern_type == "DGD":
                if idx == mvec_len - 1:
                    suppressed_mvec.append(".")
                elif bs_seq[idx + 1] == "C":
                    suppressed_mvec.append(mvec[idx])
                else:
                    suppressed_mvec.append(".")
    suppressed_mvec_str = "".join(suppressed_mvec)
    return suppressed_mvec_str


for l in sys.stdin:
    d_loc = [m.start() for m in re.finditer("\t",l)]
    sam_flag = l[d_loc[0] + 1 : d_loc[1]]
    bs_seq = l[d_loc[8] + 1: d_loc[9]]
    mvec = l[d_loc[12] + 1 + 5: d_loc[13]]
    if sam_flag in ["99", "147"]:
        suppressed_mvec_str = suppress_non_cg_gc(bs_seq, mvec, pattern_type = "HCH")
    elif sam_flag in ["83", "163"]:
        suppressed_mvec_str = suppress_non_cg_gc(bs_seq, mvec, pattern_type = "DGD")
    to_write = l[0:d_loc[12]] + "\t" + "XM:Z:" + suppressed_mvec_str + "\t" + l[d_loc[13] +1:len(l) - 1]
    print (to_write)
